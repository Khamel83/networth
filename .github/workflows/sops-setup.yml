name: SOPS Secrets Setup

on:
  # Manual trigger for initial setup
  workflow_dispatch:
    inputs:
      setup_type:
        description: 'Type of setup to perform'
        required: true
        default: 'init'
        type: choice
        options:
          - init
          - rotate
          - test

env:
  SOPS_VERSION: "3.8.1"

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      secrets: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SOPS
        run: |
          # Install SOPS (Secrets Operations)
          wget https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64
          sudo mv sops-v${SOPS_VERSION}.linux.amd64 /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops

          # Verify installation
          sops --version

      - name: Install Age (for SOPS encryption)
        run: |
          # Install age for modern encryption
          wget https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz
          tar -xvf age-v1.1.1-linux-amd64.tar.gz
          sudo mv age/age /usr/local/bin/
          sudo mv age/age-keygen /usr/local/bin/

          # Verify installation
          age --version

      - name: Setup GPG (if available)
        if: ${{ secrets.PGP_PRIVATE_KEY != '' }}
        run: |
          # Import GPG key if provided as secret
          echo "${{ secrets.PGP_PRIVATE_KEY }}" | gpg --import --batch --yes

          # List imported keys
          gpg --list-secret-keys

      - name: Create Age key (if no GPG)
        if: ${{ secrets.PGP_PRIVATE_KEY == '' }}
        run: |
          # Generate age key for SOPS encryption
          age-keygen -o age-key.txt

          # Extract public key
          PUBLIC_KEY=$(cat age-key.txt | grep "public key" | cut -d' ' -f2)
          echo "AGE_PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV

          # Store private key as secret for future use
          PRIVATE_KEY=$(cat age-key.txt | grep "private key" | sed -n '2p' | cut -d' ' -f2)
          echo "::add-mask::$PRIVATE_KEY"

          echo "Age key generated. Add the public key to your team:"
          echo "$PUBLIC_KEY"

      - name: Create encrypted environment template
        run: |
          cat > .env.encrypted.template << 'EOF'
          # NET WORTH Tennis Ladder - Encrypted Environment Variables
          # This file is encrypted with SOPS and contains sensitive configuration

          # Email Configuration
          EMAIL_FROM_ADDRESS="matches@networthtennis.com"
          SMTP_HOST="smtp.gmail.com"
          SMTP_PORT=587
          SMTP_USER="networthtennis@gmail.com"
          SMTP_PASSWORD="encrypted_password_here"

          # External API Keys (optional)
          WEATHER_API_KEY="encrypted_api_key_here"
          MAPS_API_KEY="encrypted_api_key_here"

          # Secrets Vault Integration (optional)
          SECRETS_VAULT_TOKEN="encrypted_token_here"
          SECRETS_VAULT_URL="https://your-vault-server.com"

          # Database (if using legacy mode)
          DATABASE_URL="encrypted_connection_string_here"
          EOF

      - name: Encrypt example files (if age key available)
        if: ${{ env.AGE_PUBLIC_KEY != '' }}
        run: |
          # Create sample encrypted configuration
          cat > secrets/networth-secrets.toml << 'EOF'
          # NET WORTH Secrets Configuration
          # This file is encrypted and contains sensitive data

          [email]
          from_address = "matches@networthtennis.com"
          smtp_host = "smtp.gmail.com"
          smtp_port = 587
          smtp_user = "networthtennis@gmail.com"
          smtp_password = "your_app_password"

          [external_apis]
          weather_api_key = "your_weather_api_key"
          maps_api_key = "your_maps_api_key"

          [secrets_vault]
          token = "your_vault_token"
          url = "https://your-vault-server.com"
          EOF

          # Encrypt the secrets file
          sops --encrypt --age $AGE_PUBLIC_KEY secrets/networth-secrets.toml

          # Create an example encrypted .env file
          sops --encrypt --age $AGE_PUBLIC_KEY --output .env.encrypted .env.encrypted.template

          echo "Encrypted files created:"
          echo "- secrets/networth-secrets.toml (will be .enc)"
          echo "- .env.encrypted (template for environment variables)"

      - name: Setup GitHub secrets instructions
        run: |
          echo "## SOPS Setup Complete!"
          echo ""
          echo "### Next Steps:"
          echo ""
          echo "1. **Add age key to your team**: Store the public key generated above"
          echo "2. **Create GitHub secrets**: Add the following secrets to your repository:"
          echo "   - AGE_PRIVATE_KEY: $(if [ -f age-key.txt ]; then cat age-key.txt | grep 'private key' | sed -n '2p' | cut -d' ' -f2; else echo 'your_age_private_key'; fi)"
          echo "   - PGP_PRIVATE_KEY: (optional) Your PGP private key fingerprint"
          echo ""
          echo "3. **Test encryption**: Use the workflow to test SOPS functionality"
          echo ""
          echo "### Usage Examples:"
          echo ""
          echo "To encrypt a file:"
          echo "  sops --encrypt --age \$AGE_PUBLIC_KEY file.toml"
          echo ""
          echo "To decrypt a file:"
          echo "  sops --decrypt file.toml.enc"
          echo ""
          echo "To edit an encrypted file:"
          echo "  sops file.toml.enc"

      - name: Commit SOPS configuration
        if: ${{ github.event.inputs.setup_type == 'init' }}
        run: |
          git config user.name "networth-bot"
          git config user.email "networth-bot@users.noreply.github.com"

          git add .sops.yaml secrets/ .env.encrypted*
          git add age-key.txt* || true

          git commit -m "ðŸ” Add SOPS configuration for secret management

          - Added .sops.yaml for encryption rules
          - Created encrypted secrets templates
          - Setup GitHub Actions for SOPS integration

          ðŸ¤– Generated with Claude Code

          Secrets are encrypted and can be safely committed to the repository."

          git push

  test-secrets:
    if: ${{ github.event.inputs.setup_type == 'test' }}
    runs-on: ubuntu-latest
    needs: setup-secrets
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SOPS and Age
        run: |
          wget https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64
          sudo mv sops-v${SOPS_VERSION}.linux.amd64 /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops

          wget https://github.com/FiloSottile/age/releases/download/v1.1.1/age-v1.1.1-linux-amd64.tar.gz
          tar -xvf age-v1.1.1-linux-amd64.tar.gz
          sudo mv age/age /usr/local/bin/
          sudo mv age/age-keygen /usr/local/bin/

      - name: Test SOPS decryption
        env:
          AGE_PRIVATE_KEY: ${{ secrets.AGE_PRIVATE_KEY }}
        run: |
          # Test decryption of encrypted files (if they exist)
          if [ -f "secrets/networth-secrets.toml.enc" ]; then
            echo "Testing decryption of secrets file..."
            sops --decrypt secrets/networth-secrets.toml.enc
            echo "âœ… Secrets file decrypted successfully"
          else
            echo "â„¹ï¸ No encrypted secrets file found to test"
          fi

          if [ -f ".env.encrypted" ]; then
            echo "Testing decryption of environment file..."
            sops --decrypt .env.encrypted
            echo "âœ… Environment file decrypted successfully"
          else
            echo "â„¹ï¸ No encrypted environment file found to test"
          fi

          echo "ðŸŽ‰ SOPS configuration test completed!"