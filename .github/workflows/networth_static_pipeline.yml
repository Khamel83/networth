name: NET WORTH Static Pipeline

on:
  # Run on pushes to main branch
  push:
    branches: [ main, master ]
    paths:
      - 'data/**'
      - 'scripts/**'
      - '.github/workflows/networth_static_pipeline.yml'

  # Weekly schedule - Monday 1:00 UTC (Sunday 6:00 PM LA time)
  schedule:
    - cron: '0 1 * * 1'

  # Allow manual runs
  workflow_dispatch:

jobs:
  update-static-data:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Get full history for accurate commit detection

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        # Install TOML processing libraries
        pip install tomli-w tomli

    - name: Make scripts executable
      run: |
        chmod +x scripts/*.py

    - name: Check if data files exist
      run: |
        echo "Checking data files..."
        ls -la data/
        if [ ! -f "data/players.toml" ]; then
          echo "âš ï¸ Warning: data/players.toml not found. Run bootstrap script first."
        fi

    - name: Recompute ladder rankings
      run: |
        echo "Recomputing ladder rankings..."
        python scripts/recompute_ladder.py --verbose

    - name: Generate weekly pairings
      run: |
        echo "Generating pairings..."
        python scripts/generate_pairings.py --verbose

    - name: Export static JSON for frontend
      run: |
        echo "Exporting static JSON..."
        python scripts/export_static_json.py --verbose

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi

    - name: Configure Git
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config user.name "networth-bot"
        git config user.email "networth-bot@users.noreply.github.com"

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "Committing changes..."

        # Add changed files
        git add data/*.toml public/*.json

        # Create commit message
        COMMIT_MSG="ğŸ”„ Update ladder and pairings"

        # Add details to commit message
        if [ -f "data/ladder_snapshot.toml" ]; then
          TIMESTAMP=$(grep "generated_at" data/ladder_snapshot.toml | cut -d'"' -f2)
          COMMIT_MSG="$COMMIT_MSG ($TIMESTAMP)"
        fi

        COMMIT_MSG="$COMMIT_MSG

        Generated by NET WORTH Static Pipeline
        - Ladder rankings updated
        - Weekly pairings generated
        - Static JSON exported

        ğŸ¤– Generated with Claude Code"

        git commit -m "$COMMIT_MSG"

        echo "Pushing changes..."
        git push

    - name: Create summary
      run: |
        echo "# NET WORTH Static Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Scripts executed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Data files processed" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "- âœ… Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Files Updated" >> $GITHUB_STEP_SUMMARY
          git status --porcelain | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
        else
          echo "- â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Data Files Status" >> $GITHUB_STEP_SUMMARY
        echo "- Players: \`$([ -f "data/players.toml" ] && echo "âœ… Found" || echo "âŒ Missing")\`" >> $GITHUB_STEP_SUMMARY
        echo "- Ladder: \`$([ -f "data/ladder_snapshot.toml" ] && echo "âœ… Generated" || echo "âŒ Missing")\`" >> $GITHUB_STEP_SUMMARY
        echo "- Pairings: \`$([ -f "data/pairings.toml" ] && echo "âœ… Generated" || echo "âŒ Missing")\`" >> $GITHUB_STEP_SUMMARY
        echo "- JSON Export: \`$([ -f "public/ladder.json" ] && echo "âœ… Exported" || echo "âŒ Missing")\`" >> $GITHUB_STEP_SUMMARY

  # Optional: Add secrets-vault integration if needed
  setup-secrets:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.setup_secrets == 'true'
    needs: update-static-data

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup secrets-vault integration
      run: |
        echo "ğŸ” Secrets vault integration can be added here"
        echo "Add Khamel83/secrets-vault setup steps as needed"